drop database bd_projetofinal;
create database bd_projetoFinal;
use bd_projetoFinal;

CREATE TABLE usuario (
    idUsuario INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    senha VARCHAR(40) NOT NULL,
    email VARCHAR(130) NOT NULL,
    cpf CHAR(14) NOT NULL,
    telefone CHAR(15) NOT NULL,
    nascimento DATE NOT NULL,
	stats INT NOT NULL DEFAULT 1);

CREATE TABLE categoria (
    idCategoria INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(45) NOT NULL
);

CREATE TABLE produto (
    idProduto INT AUTO_INCREMENT PRIMARY KEY,
    categoria INT(10) NOT NULL,
    nome VARCHAR(45) NOT NULL,
    descricao TINYTEXT NOT NULL,
    preco FLOAT(8,2),
    estoque INT NOT NULL,
    img VARCHAR(255),
	KEY categoria_produtos (categoria),
	CONSTRAINT categoria_produtos FOREIGN KEY (categoria) REFERENCES categoria (idCategoria));
    
CREATE TABLE pedidos (
    idPedidos INT AUTO_INCREMENT PRIMARY KEY,
    idUsuario INT NOT NULL,
    data_pedido TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idUsuario) REFERENCES usuario(idUsuario));

CREATE TABLE carrinho (
    idCarrinho INT AUTO_INCREMENT PRIMARY KEY,
    idUsuario INT NOT NULL,
    idProduto INT NOT NULL,
    idPedidos INT NOT NULL,
    quantidade INT NOT NULL,
    data_compra TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (idUsuario) REFERENCES usuario(idUsuario),
    FOREIGN KEY (idProduto) REFERENCES produto(idProduto),
    FOREIGN KEY (idPedidos) REFERENCES pedidos(idPedidos));

CREATE TABLE checkout (
    idCheckout INT AUTO_INCREMENT PRIMARY KEY,
    idUsuario INT NOT NULL,
    idProduto INT NOT NULL,
    quantidade INT NOT NULL,
    FOREIGN KEY (idUsuario) REFERENCES usuario(idUsuario),
    FOREIGN KEY (idProduto) REFERENCES produto(idProduto));
 
 INSERT INTO categoria (idCategoria,nome) VALUES
(1,'Celular'),(2,'PC'),(3,'Console'),(4,'TV');

INSERT INTO produto (categoria, nome, descricao, preco, estoque) VALUES
(1, 'Celular 1', 'Smartphone moderno com tela de alta resolução e câmera de alta qualidade.', 1500.00, 10),
(2, 'PC 1', 'Computador desktop potente para jogos e trabalho.', 2500.00, 5),
(3, 'Console 1', 'Console de videogame de última geração com gráficos incríveis.', 1200.00, 8),
(3, 'Console 2', 'Console portátil para jogar em qualquer lugar.', 800.00, 12),
(4, 'TV 2', 'TV LED Full HD com tela grande para uma experiência de cinema em casa.', 1500.00, 5),
(1, 'Celular 3', 'Smartphone com câmera tripla e bateria de longa duração.', 1800.00, 6),
(2, 'PC 3', 'Computador all-in-one com tela touch screen e design compacto.', 2200.00, 4),
(4, 'TV 3', 'Smart TV com tecnologia de imagem HDR para cores mais vibrantes.', 2300.00, 2),
(1, 'Celular 4', 'Smartphone com tela dobrável e tecnologia 5G.', 2500.00, 7),
(2, 'PC 4', 'Computador com sistema de refrigeração líquida para máximo desempenho.', 3500.00, 3),
(3, 'Console 4', 'Console com controle sem fio e suporte a jogos multiplayer online.', 1400.00, 9),
(4, 'TV 4', 'TV 8K com tecnologia de upscaling para imagens mais nítidas.', 5000.00, 1);
 
 insert into usuario(nome,senha,email,cpf,telefone,nascimento,stats)values
('Lucas','admin123','lucas@gmail.com','12344543565','1212345678','2004-05-19',2),
('Luk','123','luk@gmail.com','54356512344','4567812123','2006-11-14',1);

 
DELIMITER //

CREATE TRIGGER insert_pedidos
AFTER INSERT ON pedidos
FOR EACH ROW
BEGIN
    INSERT INTO checkout (idUsuario, idProduto, quantidade)
    SELECT idUsuario, idProduto, quantidade
    FROM carrinho
    WHERE idUsuario = NEW.idUsuario AND idPedidos = NEW.idPedidos;

    DELETE FROM carrinho
    WHERE idUsuario = NEW.idUsuario AND idPedidos = NEW.idPedidos;
END //

DELIMITER ;
